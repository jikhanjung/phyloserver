{% extends "nkfbase.html" %}
{% block content %}
<h4 class="bd-title p-2 bg-secondary text-light">Combined Cluster</h4>
<table class="table table-striped table-sm table-bordered">
    <thead>
    <tr><td>
        <div class="row">
            <div class="col">
                <a href="{% url 'download_combined_cluster' %}?locality_level={{locality_level}}&genus_species_select={{genus_species_select}}&{{urlparameter.chronounit}}&exclude_china_only_taxa={{exclude_china_only_taxa}}">[Download data]</a><br/>
                <a href="{% url 'show_combined_cluster' %}?locality_level={{locality_level}}&genus_species_select={{genus_species_select}}&{{urlparameter.chronounit}}&exclude_china_only_taxa={{exclude_china_only_taxa}}">[Show cluster]</a>
            </div>
            <div class="col">
                <form method="GET" action="{% url 'show_combined_table'%}">
                {% csrf_token %}
                <div style="background-color:lightgray; width:500px">
                    <span style="display: inline-block;"><input type="checkbox" name="exclude_china_only_taxa" value="1" {%if exclude_china_only_taxa %}checked{%endif%}>Exclude China only taxa</span>
                </div>
                <div style="background-color:white; width:500px">
                    ChronoUnit:
                    {%for chronounit in chronounit_choices%}
                    <span style="display: inline-block;"><input type="checkbox" name="selected_chronounit" value="{{chronounit}}" {%if chronounit in selected_chronounit%}checked{%endif%}>{{chronounit}}</span>
                    {%endfor%}
                </div>
                <div style="background-color:lightgray; width:500px;">
                    Locality: 
                    <input type="radio" id="locality_level1" name="locality_level" value="1" {%if locality_level == 1%}checked{%endif%}>Level 1
                    <input type="radio" id="locality_level2" name="locality_level" value="2" {%if locality_level == 2%}checked{%endif%}>Level 2
                    <input type="radio" id="locality_level3" name="locality_level" value="3" {%if not locality_level == 1 and not locality_level == 2%}checked{%endif%}>Level 3
                </div>
                <div style="background-color: white; width:500px;">
                    Group by:
                    <input type="radio" id="genus_select" name="genus_species_select" value="genus" {%if genus_species_select == "genus"%}checked{%endif%}>genus
                    <input type="radio" id="species_select" name="genus_species_select" value="species" {%if genus_species_select != "genus"%}checked{%endif%}>species</div><span>
                <button type="submit">보기</button></span>
                </form>
            </div>
        </div>
    </td></tr></thead>
    <tbody>
        <tr><td>
            <div>
                <canvas id="cluster_canvas">

                </canvas>
            </div>
        </td></tr>
        <tr><td>
            <table id="cluster_data" class="table">
            </table>
        </td></tr>
    </tbody>
</table>
<script>
function get_simpsons_index(data_a, data_b){
    //document.write(data_a,"<br/>");
    //document.write(data_b,"<br/>");
    count_a = 0; count_b = 0; common = 0;
    for(var idx=0;idx<data_a.length;idx++){
        if( data_a[idx] == 0 && data_b[idx] == 0 ) {
            continue
        }
        if( data_a[idx] == 1 ) { count_a += 1; }
        if( data_b[idx] == 1 ) { count_b += 1; }
        if( data_a[idx] == 1 && data_b[idx] == 1 ) { common += 1; }
    }
    if( count_a > count_b ) { denominator = count_b; } else { denominator = count_a; }
    if( denominator == 0 ) { 
        //document.write("divide by zero"); 
        return 0;
    }
    return (parseFloat(common) / parseFloat(denominator));
}
function get_jaccards_index(data_a, data_b){
    //document.write(data_a,"<br/>");
    //document.write(data_b,"<br/>");
    count_a = 0; count_b = 0; common = 0;
    for(var idx=0;idx<data_a.length;idx++){
        if( data_a[idx] == 0 && data_b[idx] == 0 ) {
            continue
        }
        if( data_a[idx] == 1 ) { count_a += 1; }
        if( data_b[idx] == 1 ) { count_b += 1; }
        if( data_a[idx] == 1 && data_b[idx] == 1 ) { common += 1; }
    }
    return (parseFloat(common) / parseFloat(count_a+count_b-common));
}

function get_sorenson_index(data_a, data_b){
    //document.write(data_a,"<br/>");
    //document.write(data_b,"<br/>");
    count_a = 0; count_b = 0; common = 0;
    for(var idx=0;idx<data_a.length;idx++){
        if( data_a[idx] == 0 && data_b[idx] == 0 ) {
            continue
        }
        if( data_a[idx] == 1 ) { count_a += 1; }
        if( data_b[idx] == 1 ) { count_b += 1; }
        if( data_a[idx] == 1 && data_b[idx] == 1 ) { common += 1; }
    }
    return (parseFloat(common*2) / parseFloat(count_a+count_b));
}

var json_data = JSON.parse("{{data_json|escapejs}}");
var taxa_list = JSON.parse("{{taxa_json|escapejs}}");
var keys = Object.keys(json_data);
//document.write(keys);
var table = document.getElementById("cluster_data");
var row = table.insertRow();
col = row.insertCell();
indices = [ 'Simpson', 'Jaccard','Sørenson'];
for(var i=0;i<3;i++){
    for( var idx2=19;idx2<21;idx2++){
        col = row.insertCell();
        col.innerHTML = keys[idx2] + "(" + indices[i]+")";
    }
}
for( var idx=0;idx<19;idx++){
    //document.write("idx:",idx);
    //document.write(keys[idx],idx,"<br/>");
    //document.write(keys[idx],"<br/>");
    var row = table.insertRow();
    col = row.insertCell();
    col.innerHTML = keys[idx];
    for( var idx2=19;idx2<21;idx2++){
        //document.write("idx2:",idx2);
        //document.write(keys[idx2],idx2,"<br/>");
        
        //document.write(keys[idx2],"<br/>");
        col = row.insertCell();
        if( idx != idx2 ) {
            var val = get_simpsons_index(json_data[keys[idx]],json_data[keys[idx2]]);
            //document.write(idx + " vs " + idx2 + ": " +  val + "<br/>");
            col.innerHTML = Math.round( val * 100 ) / 100.0;
        }   
    }
    for( var idx2=19;idx2<21;idx2++){
        //document.write("idx2:",idx2);
        //document.write(keys[idx2],idx2,"<br/>");
        
        //document.write(keys[idx2],"<br/>");
        col = row.insertCell();
        if( idx != idx2 ) {
            var val = get_jaccards_index(json_data[keys[idx]],json_data[keys[idx2]]);
            //document.write(idx + " vs " + idx2 + ": " +  val + "<br/>");
            col.innerHTML = Math.round( val * 100 ) / 100.0;
        }   
    }
    for( var idx2=19;idx2<21;idx2++){
        //document.write("idx2:",idx2);
        //document.write(keys[idx2],idx2,"<br/>");
        
        //document.write(keys[idx2],"<br/>");
        col = row.insertCell();
        if( idx != idx2 ) {
            var val = get_sorenson_index(json_data[keys[idx]],json_data[keys[idx2]]);
            //document.write(idx + " vs " + idx2 + ": " +  val + "<br/>");
            col.innerHTML = Math.round( val * 100 ) / 100.0;
        }   
    }

}

</script>
{% endblock %}