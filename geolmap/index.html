<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
	<title>한국 지질도</title>
</head>
<body>
	<!--div id="timeline" style="width:100%;height:10%;z-index:30;"></div-->
	<!--div id="date_div" style="position:relative;margin:auto;height:35px;width:100%;text-align:center;z-index:20;"></div-->
	<!--div id="option_div" style="position:absolute;left:3px;top:3px;width:200px;z-index:10;background-color:#EEEEEE"-->
	<div id="option_div" style="position:absolute;left:3px;top:3px;width:200px;z-index:10;background-color: rgba(238, 238, 238, 0.5)">
		<div id="geolmap_div">
<div><a href="info.html">페이지 정보</a></div>
				<input id="geolmap" type="checkbox" checked onClick="javascript:toggle_geolmap();"><span id="geolmap_span">지질도</span></input></br>
<div class="slidecontainer">
  <input type="range" min="0" max="100" value="50" class="slider" id="slider" onChange="javascript:set_opacity();">
</div>
				<input id="legend_input1" type="checkbox" onClick="javascript:toggle_legend1();"><span id="legend_span">화성암 정보</span></input></br>
				<input id="legend_input2" type="checkbox" onClick="javascript:toggle_legend2();"><span id="legend_span">지질시대 정보</span></input>
		</div>
	</div>
	<div id="legend" style="position:absolute;left:3px;top:115px;width:200px;z-index:10;background-color:rgba(238,238,238,0.5);">
	<!--div id="legend1" style="absolute;left:20px;top:95px;width:200px;z-index:10;background-color:#EEEEEE;display:none;"-->
	<div id="legend1" style="display:none">
<ul>
  <li>심성암</li>
    <ul><li>γ: 산성</li><li>δ: 중성</li><li>ν: 염기성</li><li>σ: 초염기성</li><li>χ: 알칼리</li><li>ξ: 섬장암</li><li>η: 회장암)</li></ul>
  <li>반심성암</li>
    <ul><li>γπ: 산성</li><li>δπ: 중성</li><li>νπ: 염기성</li><li>τπ: 조면암질</li></ul>
  <li>화산암</li>
    <ul><li>λ: 산성</li><li> α: 중성</li><li>β: 염기성</li><li>τ: 조면암질</li></ul>
</ul>
	</div>
	<!--div id="legend2" style="position:absolute;left:20px;top:500px;width:200px;z-index:10;background-color:#EEEEEE;display:none;"-->
	<div id="legend2" style="display:none">
<ul>
<li>신생대</li>
  <ul>
    <li>Q: 제4기</li>
    <li>N: 신신기</li>
    <li><img src="images/paleogene.png" width="16"/>: 고신기</li>
  </ul>
<li>중생대</li>
  <ul>
    <li>K: 백악기</li>
    <li>J: 쥐라기</li>
    <li>T: 트라이아스기</li>
  </ul>
<li>고생대</li>
  <ul>
    <li>P: 페름기</li>
    <li>C: 석탄기</li>
    <li>D: 데본기</li>
    <li>S: 실루리아기</li>
    <li>O: 오르도비스기</li>
    <li>Ꞓ: 캄브리아기</li>
  </ul>
<li>고생대 이전</li>
  <ul>
    <li>X: 신원생대</li>
    <li>Y: 중원생대</li>
    <li>Z: 고원생대</li>
    <li>A: 신시생대</li>
  </ul>
</ul>
        </div>
</div>
	<div id="select_div" style="display:none;position:absolute;left:20px;top:110px;height:90vh;width:120px;z-index:10;">
	</div>
	<!--div id="finid_div" style="position:absolute;left:130px;top:20px;height:90vh;width:10vw;z-index:20;"></div-->
	<div id="map" style="position:absolute;top:0px;left:0px;height:100%;width:100%;z-index:0;"></div>
	<script type="text/javascript" src="jquery-3.5.1.min.js"></script>
	<script type="text/javascript" src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=4b9a35682a95fbd9ec4733796320db8e"></script>
	<!--script type="text/javascript" src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script-->
	<!--link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" /-->
	<style type="text/css">
	  #timeline {
		width: 100%;
		height: 100px;
		border: 1px solid lightgray;
	  }
	  #date_select, #finid_select {
		  overflow-y: auto;
		  width: 85px;
	  }
	  #fit_view_span {
		  font-size: 15px;
	  }
	  select {
		border: 1px solid #fff;
		background-color: transparent;
    	padding: 5px;
		text-align-last:center;
	  }

	  .map_tile {
		  opacity: 0.5;
	  }


	</style>
	<script>
var current_latitude = -1;
var current_longitude = -1;
var current_loc_position = new kakao.maps.LatLng(37.487935, 126.857758);
var zoom_level = 13;
if (navigator.geolocation) {
    console.log("geolocation available");
    console.log("getting current position");
var options = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0
};
function error_console(err) {
  //console.warn(`ERROR(${err.code}): ${err.message}`);
  //alert(`ERROR(${err.code}): ${err.message}`);
}
function success(position) {
console.log("position: position");
        var lat = position.coords.latitude; // 위도
        var lon = position.coords.longitude; // 경도
	current_latitude = lat;
	current_longitude = lon;
        current_loc_position = new kakao.maps.LatLng(lat, lon);
    zoom_level = 8;
console.log(lat, lon);
}
    
    // GeoLocation을 이용해서 접속 위치를 얻어옵니다
    navigator.geolocation.getCurrentPosition(success, error_console, options);
} else {
  console.log("geolocation unavailable");
}


var container = document.getElementById('map');
var options = {
	//center: new kakao.maps.LatLng(37.487935, 126.857758),
	center: current_loc_position,
	level:11 
};

var map = new kakao.maps.Map(container, options);
var GlobalMap = map;
var bounds = new kakao.maps.LatLngBounds();
console.log("zoom_level", zoom_level, current_latitude, current_longitude);
var zoomControl = new kakao.maps.ZoomControl();
map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

var mapTypeControl = new kakao.maps.MapTypeControl();
map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);	

var lat_sum=0, lon_sum=0, data_count=0;

var occurrence_list = [];//nk_fossil_occurrence_data;
//imagename_list.sort()
var map_info_list = [];
var coords_basis = {};
var region_overlay_list = [];
var max_row = 0; 
var max_col = 0;

// script.js
fetch('map_info.json')
    .then(response => response.json())
    .then(data => {
console.log("data fetched");
        // Assuming a pre-existing variable named 'myExistingObject'
	process_map_data(data);
        //map_info_orig = { ...map_info_orig, ...data }; // Merge into the existing object

        //console.log(map_info_orig);
    })
    .catch(error => console.error("Error fetching JSON:", error));

//console.log("map_info_orig:", map_info_orig);
function process_map_data(map_info) {
//console.log("okay now processing", map_info_orig);
coords_basis = map_info['coords_basis'];
for( var idx=0;idx<map_info['regions'].length;idx++){
	map_info_list[map_info_list.length] = map_info['regions'][idx];
	var region = map_info['regions'][idx];
	var region_name = region['name'];
	var region_row = region['row'];
	var region_col = region['col'];
	if(region_row > max_row) max_row = region_row;
	if(region_col > max_col) max_col = region_col;

	var region_lat = map_info['coords_basis']['y_0'] + region_row * map_info['coords_basis']['y_diff'] + region['rowspan'] * map_info['coords_basis']['y_diff'] / 2;
	var region_lon = map_info['coords_basis']['x_0'] + region_col * map_info['coords_basis']['x_diff'] + region['colspan'] * map_info['coords_basis']['x_diff'] / 2;

        var content = '<div class="label" region_name="' + region_name + '" id="' + region_row.toString() + '_' + region_col.toString() + '"><div>' + region_name + '</div></div>';
        var position = new kakao.maps.LatLng( region_lat, region_lon );
        var customOverlay = new kakao.maps.CustomOverlay( { position: position, content:content, map: map });
	/*var region_marker = new kakao.maps.Marker({
		position: new kakao.maps.LatLng(region_lat, region_lon),
		map: map,
		title: region_name
	});*/
//console.log(region_name);
        region_overlay_list[region_overlay_list.length] = customOverlay;
		
	var region_infowindow = new kakao.maps.InfoWindow({
		content: region_name
	});
	//kakao.maps.event.addListener(region_marker, 'click', makeOverListener(map, region_marker, region_infowindow));
	//kakao.maps.event.addListener(region_marker, 'mouseout', makeOutListener(region_infowindow));
}
}

function getChildImage(element) {
     for (const child of element.children) {
        if (child.tagName === 'IMG') {
            return child;
        }
    }
    return null; // Return null if no image found
}


function update_chart() {
	var level = map.getLevel();
	var factor = 2**(10-level);
	//console.log("zoom level:", level, "factor:", factor);
	for( var idx=0;idx<map_info_list.length;idx++){
		var region = map_info_list[idx];
		var region_name = region['name'];
		var region_row = region['row'];
		var region_col = region['col'];
		var d = document.getElementById(region_row.toString() + "_" + region_col.toString());
		if(d){
			if(level <=11 ){
				//console.log("got the div element under level9", region_row, region_col,level);
				var img_child = getChildImage(d);
				if( img_child ) { d.removeChild(img_child);}
				var img = document.createElement('img');
				urlencoded_region_name = encodeURIComponent(region_name);
				img.width=100*factor; img.height=80*factor;img.src="/rose/rose_image/?region="+urlencoded_region_name;
				d.appendChild(img);
			}else{
				var img_child = getChildImage(d);
				if( img_child ) { d.removeChild(img_child);}
			}
		}
	}
}

kakao.maps.event.addListener(map, 'zoom_changed', function() {
	update_chart();
	refresh_view();
});
kakao.maps.event.addListener(map, 'dragend', function() { 
	update_chart();
	refresh_view();
});
function refresh_view() {
	//var l_selected_date_list = filter_date();
	//var l_selected_finid_list = filter_finid();
	var l_fit_view_to_window = false;
	//filter_occurrences( l_selected_date_list, l_selected_finid_list, l_fit_view_to_window );
	//cluster_markers();
	
	//console.log(map.getLevel());
}
show_legend1=false;
show_legend2=false;

function toggle_legend1() {
	if( show_legend1 ) {
		show_legend1 = false;
		document.getElementById("legend1").style.display="none";
	} else {
		show_legend1 = true;
		document.getElementById("legend1").style.display="block";
	}
}
function toggle_legend2() {
	if( show_legend2 ) {
		show_legend2 = false;
		document.getElementById("legend2").style.display="none";
	} else {
		show_legend2 = true;
		document.getElementById("legend2").style.display="block";
	}
}

function toggle_geolmap() {
	if( show_tile ) {
		map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TILE_NUMBER);
		show_tile = false;
	} else {
		map.addOverlayMapTypeId(kakao.maps.MapTypeId.TILE_NUMBER);
		show_tile = true;
	}
}

function set_opacity() {
    var slider = document.getElementById("slider");
    var opacity_value = slider.value;
    var img_list= document.getElementsByClassName("map_tile");
    for( var idx=0;idx<img_list.length;idx++){
        img_list[idx].style.opacity = ( opacity_value / 100.0 );
    }
    
}

function show_images( a_location_key, a_taxon ) {
	//console.log(a_location_key, a_taxon );
    var l_location = location_hash[a_location_key];
	var occ_list = l_location.occurrence_list;
	
	var myWindow = window.open("", "_blank", "width=600,height=800");
	myWindow.document.write( "<html><body><div id='show_images'></div></body></html>" );
	myWindow.document.getElementById("show_images").appendChild(myWindow.document.createTextNode("{0}".format(a_taxon)));
	myWindow.document.getElementById("show_images").appendChild(myWindow.document.createElement("br"));
	for( var idx = 0 ; idx < occ_list.length ; idx++ ){
		var occ = occ_list[idx];
		if( occ['species'] == a_taxon ) {
			console.log( idx, occ['species'], occ['plate'], occ['figure'], occ['unit_eng'] );
			var img = myWindow.document.createElement('img');
			img.src = "fossil_images/{0}-{1}.png".format(occ['plate'],occ['figure']);
			myWindow.document.getElementById("show_images").appendChild(myWindow.document.createTextNode("Plate.{0}-{1} from {2}".format(occ['plate'],occ['figure'],occ['unit_eng'])));
			myWindow.document.getElementById("show_images").appendChild(myWindow.document.createElement("br"));
			myWindow.document.getElementById("show_images").appendChild(img);
			myWindow.document.getElementById("show_images").appendChild(myWindow.document.createElement("br"));
		}

	}

}



kakao.maps.Tileset.add('TILE_NUMBER', 
    new kakao.maps.Tileset({
        width: 256,
        height: 256,
        getTile: function(x, y, z) {
        	var mult = 2 ** ( 13 - z );
        	var div = document.createElement('div'); 
        	if( x >= mult * 2 || y >= mult * 5) { return div; }
        	if( z < 7 || z > 13 || x < 0 || y < 0 ) { return div;}
            var img = document.createElement('img');
			//img.style.opacity = 0.5;
			img.classList.add("map_tile");
            img.src = 'map_tiles/' + z + '/' + x + '_' + y + '.png';
            return img;
        }
    }));


// 지도 위에 TILE_NUMBER 오버레이 레이어를 추가합니다
var show_tile = true;
map.addOverlayMapTypeId(kakao.maps.MapTypeId.TILE_NUMBER);
map.setMinLevel(7);
map.setMaxLevel(12);
//filter_occurrences( age_list, true);


</script>
</body>
</html>
