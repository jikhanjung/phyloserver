<!-- Add Lightbox CSS and JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>

<!-- Custom Image Viewer Modal -->
<div id="customImageViewer" class="modal" tabindex="-1" role="dialog" style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);">
    <div class="modal-content" style="margin: 0; padding: 0; width: 100%; height: 100%; max-width: none; position: relative; background-color: transparent; border: none; box-shadow: none;">
        <span class="close-viewer" style="position: fixed; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1060;">&times;</span>
        <div id="imageContainer" style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; overflow: hidden;">
            <img id="viewerImage" style="display: block; margin: 0; max-width: 100%; max-height: 100vh; object-fit: contain; cursor: move;">
        </div>
        <div id="imageCaption" style="position: fixed; bottom: 10px; left: 0; right: 0; text-align: center; color: white; padding: 10px 0; height: 50px; background-color: rgba(0,0,0,0.5); z-index: 1051;"></div>
        
        <div id="viewControls" style="position: fixed; top: 15px; right: 70px; z-index: 1060;">
            <button id="fitToScreenBtn" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 5px;" disabled>Fit to Screen</button>
            <button id="originalSizeBtn" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Original Size</button>
        </div>
        
        <div id="zoomControls" style="position: fixed; bottom: 70px; right: 20px; z-index: 1052;">
            <button id="zoomIn" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 4px; padding: 5px 10px; margin-right: 5px; cursor: pointer;">+</button>
            <button id="zoomReset" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 4px; padding: 5px 10px; margin-right: 5px; cursor: pointer;">100%</button>
            <button id="zoomOut" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">-</button>
        </div>
        
        <button id="prevImage" style="position: fixed; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.3); border: none; color: white; font-size: 24px; padding: 15px; cursor: pointer; border-radius: 50%; z-index: 1052;">&lt;</button>
        <button id="nextImage" style="position: fixed; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.3); border: none; color: white; font-size: 24px; padding: 15px; cursor: pointer; border-radius: 50%; z-index: 1052;">&gt;</button>
    </div>
</div>

<style>
    .image-gallery img {
        transition: transform 0.3s ease;
    }
    .image-gallery img:hover {
        transform: scale(1.05);
    }
    .lb-toggle-orig {
        position: absolute;
        right: 10px;
        top: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
        z-index: 9999;
    }
    .lb-toggle-orig:hover {
        background: rgba(0, 0, 0, 0.8);
    }
</style>

<script>
// Initialize gallery viewer
function initializeGalleryViewer() {
    // Try standard Lightbox first
    lightbox.option({
        'resizeDuration': 200,
        'wrapAround': true,
        'albumLabel': 'Image %1 of %2',
        'fadeDuration': 200,
        'fitImagesInViewport': true
    });
    
    // Custom image viewer
    let currentImageIndex = 0;
    let galleryImages = [];
    let zoomLevel = 1;
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;
    let lastTranslateX = 0, lastTranslateY = 0;
    let originalImageWidth = 0;
    let originalImageHeight = 0;
    let fitScale = 1; // Scale factor when fit to screen
    let isFitToScreen = true;
    
    // Collect all gallery images and their info
    $('.gallery-item').each(function(index) {
        galleryImages.push({
            src: $(this).attr('href'),
            title: $(this).attr('data-title') || '',
            element: $(this)
        });
    });
    
    // Custom image viewer click handler
    $('.gallery-item').on('click', function(e) {
        e.preventDefault();
        
        // Find this image's index
        const clickedSrc = $(this).attr('href');
        currentImageIndex = galleryImages.findIndex(img => img.src === clickedSrc);
        
        // Show the image in our viewer
        showImageInViewer(currentImageIndex);
        
        // Show the modal
        $('#customImageViewer').fadeIn();
        
        return false;
    });
    
    // Function to display an image in the custom viewer
    function showImageInViewer(index) {
        const image = galleryImages[index];
        
        // Reset zoom and position
        zoomLevel = 1;
        translateX = 0;
        translateY = 0;
        lastTranslateX = 0;
        lastTranslateY = 0;
        isFitToScreen = true;
        
        const viewerImage = $('#viewerImage');
        viewerImage.attr('src', image.src);
        $('#imageCaption').text(image.title);
        currentImageIndex = index;
        
        // Initial state: fit to screen
        viewerImage.css({
            'max-width': '100%',
            'max-height': '100vh',
            'object-fit': 'contain',
            'transform': 'translate(0px, 0px) scale(1)'
        });
        
        // Reset button states
        $('#fitToScreenBtn').prop('disabled', true);
        $('#originalSizeBtn').prop('disabled', false);
        
        // Show zoom controls
        $('#zoomControls').show();
        $('#zoomReset').text('Fit');
        
        // Get original image dimensions after it loads
        viewerImage.on('load', function() {
            const img = new Image();
            img.onload = function() {
                originalImageWidth = this.width;
                originalImageHeight = this.height;
                
                // Calculate fit scale by comparing original image dimensions to container
                const containerWidth = $('#imageContainer').width();
                const containerHeight = $('#imageContainer').height();
                
                const scaleX = containerWidth / originalImageWidth;
                const scaleY = containerHeight / originalImageHeight;
                fitScale = Math.min(scaleX, scaleY);
                
                // Update the button states to reflect the current view
                updateButtonStates();
            };
            img.src = image.src;
        });
    }
    
    // Update button states based on current view mode
    function updateButtonStates() {
        if (isFitToScreen) {
            $('#fitToScreenBtn').prop('disabled', true);
            $('#originalSizeBtn').prop('disabled', false);
            $('#zoomReset').text('Fit');
        } else {
            // If we're at 100% original size
            if (Math.abs(zoomLevel - 1) < 0.05) {
                $('#originalSizeBtn').prop('disabled', true);
                $('#fitToScreenBtn').prop('disabled', false);
                $('#zoomReset').text('100%');
            } else {
                // At some custom zoom level
                $('#originalSizeBtn').prop('disabled', false);
                $('#fitToScreenBtn').prop('disabled', false);
                $('#zoomReset').text(`${Math.round(zoomLevel * 100)}%`);
            }
        }
    }
    
    // Next and previous buttons
    $('#nextImage').on('click', function() {
        currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
        showImageInViewer(currentImageIndex);
    });
    
    $('#prevImage').on('click', function() {
        currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
        showImageInViewer(currentImageIndex);
    });
    
    // Close the viewer
    $('.close-viewer').on('click', function() {
        $('#customImageViewer').fadeOut();
    });
    
    // Button to fit image to screen
    $('#fitToScreenBtn').on('click', function() {
        isFitToScreen = true;
        
        // Reset position and transform
        translateX = 0;
        translateY = 0;
        lastTranslateX = 0;
        lastTranslateY = 0;
        
        const img = $('#viewerImage');
        img.css({
            'max-width': '100%',
            'max-height': '100vh',
            'object-fit': 'contain',
            'transform': 'translate(0px, 0px) scale(1)'
        });
        
        // Update cursor
        img.css('cursor', 'default');
        
        // Update button states
        updateButtonStates();
    });
    
    // Button to view at original size (100%)
    $('#originalSizeBtn').on('click', function() {
        isFitToScreen = false;
        zoomLevel = 1; // 100% original size
        
        // Reset position
        translateX = 0;
        translateY = 0;
        lastTranslateX = 0;
        lastTranslateY = 0;
        
        const img = $('#viewerImage');
        img.css({
            'max-width': 'none',
            'max-height': 'none',
            'object-fit': 'none',
            'transform': 'translate(0px, 0px) scale(1)'
        });
        
        // Update cursor for dragging
        img.css('cursor', 'move');
        
        // Update button states
        updateButtonStates();
    });
    
    // Mouse drag to pan image
    $('#viewerImage').on('mousedown', function(e) {
        if (isFitToScreen) return; // Only enable dragging when not in fit-to-screen mode
        
        isDragging = true;
        startX = e.clientX - lastTranslateX;
        startY = e.clientY - lastTranslateY;
        $(this).css('cursor', 'grabbing');
        e.preventDefault(); // Prevent image dragging behavior
    });
    
    $(document).on('mousemove', function(e) {
        if (!isDragging) return;
        
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        
        $('#viewerImage').css('transform', `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`);
    });
    
    $(document).on('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            lastTranslateX = translateX;
            lastTranslateY = translateY;
            $('#viewerImage').css('cursor', 'move');
        }
    });
    
    // Zoom controls
    $('#zoomIn').on('click', function() {
        if (isFitToScreen) {
            // Switch to custom zoom mode but preserve the current fit scale
            isFitToScreen = false;
            
            // Start from the current fit scale ratio
            const img = $('#viewerImage');
            img.css({
                'max-width': 'none',
                'max-height': 'none',
                'object-fit': 'none',
                'transform': `translate(0px, 0px) scale(${fitScale})`
            });
            
            // Set initial zoom level to the fit scale
            zoomLevel = fitScale;
            
            // Update cursor for dragging if beyond fit scale
            img.css('cursor', 'move');
        }
        
        // Now increase the zoom if below max limit
        if (zoomLevel < 5) {
            zoomLevel += 0.25;
            applyZoom();
        }
    });
    
    $('#zoomOut').on('click', function() {
        if (isFitToScreen) {
            // Switch to custom zoom mode but preserve the current fit scale
            isFitToScreen = false;
            
            // Start from the current fit scale ratio
            const img = $('#viewerImage');
            img.css({
                'max-width': 'none',
                'max-height': 'none',
                'object-fit': 'none',
                'transform': `translate(0px, 0px) scale(${fitScale})`
            });
            
            // Set initial zoom level to the fit scale
            zoomLevel = fitScale;
            
            // Update cursor for dragging if beyond fit scale
            img.css('cursor', 'move');
        }
        
        // Now decrease the zoom
        if (zoomLevel > 0.25) {
            zoomLevel -= 0.25;
            applyZoom();
        }
    });
    
    $('#zoomReset').on('click', function() {
        if (isFitToScreen) {
            // If we're already in fit mode, switch to original size
            $('#originalSizeBtn').click();
        } else {
            // Otherwise, go back to fit mode
            $('#fitToScreenBtn').click();
        }
    });
    
    // Apply current zoom level
    function applyZoom() {
        $('#viewerImage').css('transform', `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`);
        updateButtonStates();
    }
    
    // Mouse wheel zoom
    $('#imageContainer').on('wheel', function(e) {
        e.preventDefault();
        
        // If in fit-to-screen mode, first switch to custom zoom while preserving the fit scale
        if (isFitToScreen) {
            isFitToScreen = false;
            
            // Start from the current fit scale ratio
            const img = $('#viewerImage');
            img.css({
                'max-width': 'none',
                'max-height': 'none',
                'object-fit': 'none',
                'transform': `translate(0px, 0px) scale(${fitScale})`
            });
            
            // Set initial zoom level to the fit scale
            zoomLevel = fitScale;
            
            // Update cursor for dragging if beyond fit scale
            img.css('cursor', 'move');
        }
        
        // Zoom in or out based on scroll direction
        if (e.originalEvent.deltaY < 0) {
            // Zoom in
            if (zoomLevel < 5) {
                zoomLevel += 0.1;
            }
        } else {
            // Zoom out
            if (zoomLevel > 0.25) {
                zoomLevel -= 0.1;
            }
        }
        
        zoomLevel = Math.round(zoomLevel * 10) / 10; // Round to nearest 0.1
        applyZoom();
    });
    
    // Close when clicking outside the image
    $('#customImageViewer').on('click', function(e) {
        if (e.target === this) {
            $(this).fadeOut();
        }
    });
    
    // Support keyboard navigation
    $(document).on('keydown', function(e) {
        if (!$('#customImageViewer').is(':visible')) return;
        
        switch (e.keyCode) {
            case 37: // Left arrow
                $('#prevImage').click();
                break;
            case 39: // Right arrow
                $('#nextImage').click();
                break;
            case 27: // Escape
                $('.close-viewer').click();
                break;
            case 187: // Plus (+)
                $('#zoomIn').click();
                break;
            case 189: // Minus (-)
                $('#zoomOut').click();
                break;
            case 48: // Zero (0)
                $('#zoomReset').click();
                break;
            case 70: // F key
                $('#fitToScreenBtn').click();
                break;
        }
    });
    
    // Add toggle original size button to Lightbox (as fallback)
    $(document).on('click', '[data-lightbox]', function() {
        setTimeout(function() {
            // Check if button already exists
            if (!$('.lb-toggle-orig').length) {
                const toggleBtn = $('<button class="lb-toggle-orig">View Original Size</button>');
                $('.lb-dataContainer').append(toggleBtn);
                
                // Handle button click
                toggleBtn.on('click', function() {
                    const image = $('.lb-image');
                    const container = $('.lb-outerContainer');
                    
                    if (toggleBtn.text() === 'View Original Size') {
                        // Switch to original size
                        image.css({
                            'max-width': 'none',
                            'max-height': 'none'
                        });
                        container.css({
                            'width': 'auto',
                            'height': 'auto'
                        });
                        toggleBtn.text('Fit to Screen');
                    } else {
                        // Back to fit to screen
                        image.css({
                            'max-width': '100%',
                            'max-height': '100vh'
                        });
                        container.css({
                            'width': image.width() + 'px',
                            'height': image.height() + 'px'
                        });
                        toggleBtn.text('View Original Size');
                    }
                });
            }
        }, 100); // Small delay to ensure lightbox is fully loaded
    });
}

// Call when document is ready
$(document).ready(function() {
    initializeGalleryViewer();
});
</script> 